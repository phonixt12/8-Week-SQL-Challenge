## Case Study #1: Danny's Diner
<p align="center">
<img src="https://github.com/hatrang12/8weeksqlchallenge.com/blob/main/1.png" align="center" width="400" height="400" >


## Table of Content
1. [Business Task](#Business-Task)
2. [Entity Relationship Diagram](#entity-relationship-diagram)
3. [Case Study Questions](#Question-and-Solution)

If you are interest in this case study you can find it in this [link](https://8weeksqlchallenge.com/case-study-1/)
## Business Task 
Danny wants to analyze customer data to gain insights into their visiting patterns, spending habits, and favorite menu items. He aims to establish a deeper connection with his customers to enhance their experience. Specifically, he plans to use these insights to decide whether to expand the current customer loyalty program. To facilitate the analysis, Danny needs help generating basic datasets that his team can easily inspect without using SQL directly. Despite privacy concerns, he has provided a sample of customer data for the purpose of creating fully functioning SQL queries to address his questions

## Entity Relationship Diagram
![entity_relationship_diagram](https://github.com/hatrang12/8weeksqlchallenge.com/assets/107136018/b2325eb0-4927-495d-9530-82e32dc05af5)

## Question and Solution
#### 1.What is the total amount each customer spent at the restaurant?

````sql
SELECT 
	  customer_id,
      sum(price) as total_amount    
FROM
	 dannys_diner.sales sa
JOIN
	 dannys_diner.menu me
ON 
	sa.product_id=me.product_i
GROUP BY customer_id
ORDER BY
	customer_id;
````
#### Steps:
- JOIN two table dannys_diner.sales and dannys_diner.menu by using product_id.
- Use SUM to calculate the total sales contributed by each customer.
- Group the aggregated results by sales.customer_id 
- Order it by customer_id

|  customer_id | total_pay  |
|---|---|
|A	|76|
|B	|74|
|C	|36|


#### Result
- Customer A : $76.
- Customer B : $74.
- Customer C : $36.
#### 2. How many days has each customer visited the restaurant?

````sql
SELECT 
	  customer_id,
      count(distinct order_date) visited_days
FROM
	 dannys_diner.sales sa
  
GROUP BY customer_id;
````
#### Steps:
- The order_date column is not unique value so we need to count distinct in this question, utilize **COUNT(DISTINCT `order_date`)**.
- It will avoid duplicate counting of days. 
|  customer_id | visit_count  |
|---|---|
|A	|4|
|B	|6|
|C	|2|

#### Result 
- Customer A visited 4 times.
- Customer B visited 6 times.
- Customer C visited 2 times.

3. What was the first item from the menu purchased by each customer?

 ````sql

with pre_data as (
  
SELECT 
	  customer_id,
  	  product_name,
  	  order_date,
      dense_rank() over (partition by customer_id order by order_date) ranks 
  FROM
	 dannys_diner.sales sa
JOIN
	 dannys_diner.menu me
ON 
	sa.product_id=me.product_id
 ) 
SELECT 
	  customer_id,
      product_name
FROM
	  pre_data   
WHERE
	   ranks=1
GROUP BY customer_id,product_name

````


| customer_id | order_date | product_name |
|---|------------|-------|
| A | 2021-01-01 | curry |
| A | 2021-01-01 | sushi |
| B | 2021-01-01 | curry |
| C | 2021-01-01 | ramen |

4.What is the most purchased item on the menu and how many times was it purchased by all customers?

````sql

with pre_data as
(SELECT 
      product_name,
      count(sa.product_id) buying_times
      
FROM
	 dannys_diner.sales sa
 JOIN
	 dannys_diner.menu me
ON 
	sa.product_id=me.product_id
GROUP BY product_name
)


SELECT 
	  product_name,
      max(buying_times) times
FROM 
	  pre_data
 GROUP BY product_name
 LIMIT 1
````
| product_name | times      |
|--------------|------------|
| ramen        | 8          |



5. Which item was the most popular for each customer?

````sql

with pre_data as
(SELECT 
	  customer_id,
      product_name,
      count(sa.product_id) buying_times,
      dense_rank() over (partition by customer_id order by  count(sa.product_id) desc) ranks
FROM
	 dannys_diner.sales sa
 JOIN
	 dannys_diner.menu me
ON 
	sa.product_id=me.product_id
GROUP BY customer_id,product_name
)


SELECT 
	  customer_id,
	  product_name,
      buying_times
FROM 
	  pre_data
 WHERE ranks = 1

````
| customer_id  |product_name|
|--------------|------------|
| A            | curry      |
| A            | sushi      |
| B	       | curry      |
| C	       | ramen      |

6. Which item was purchased first by the customer after they became a member?
````sql
with pre_data as (
SELECT
  	sa.customer_id,
    product_name,
    dense_rank() over (partition by sa.customer_id order by order_date) ranks
FROM 
	 dannys_diner.sales sa
JOIN 
	 dannys_diner.members mem
ON 
	 sa.customer_id = mem.customer_id
JOIN 
	 dannys_diner.menu me 
ON 
 	 sa.product_id = me.product_id
WHERE 
	 order_date > join_date
 )
SELECT
	  customer_id,
	  product_name
FROM
	  pre_data
WHERE 
	  ranks =1
````
| customer_id | product_name |
|-------------|--------------|
| A           | curry        | 
| B           | sushi        | 

7. Which item was purchased just before the customer became a member?
````sql
with pre_data as (
SELECT
  	sa.customer_id,
    product_name,
    row_number() over (partition by sa.customer_id order by order_date desc) ranks
FROM 
	 dannys_diner.sales sa
JOIN 
	 dannys_diner.members mem
ON 
	 sa.customer_id = mem.customer_id
JOIN 
	 dannys_diner.menu me 
ON 
 	 sa.product_id = me.product_id
WHERE 
	 order_date < join_date
 )
SELECT 
	  customer_id,
	  product_name
FROM
	  pre_data   
WHERE 
	  ranks =1

````
| customer_id | product_name |
|-------------|--------------|
| A           | sushi        | 
| B           | sushi        | 

8.What is the total items and amount spent for each member before they became a member?
````sql
with pre_data as (
SELECT
  	sa.customer_id,
    count(sa.product_id) total_items,
	sum(price) total_amount
FROM 
	 dannys_diner.sales sa
JOIN 
	 dannys_diner.members mem
ON 
	 sa.customer_id = mem.customer_id
JOIN 
	 dannys_diner.menu me 
ON 
 	 sa.product_id = me.product_id
WHERE 
	 order_date < join_date
  
GROUP BY sa.customer_id
 )
SELECT 
	  customer_id,
	  total_items,
      total_amount
FROM
	  pre_data
ORDER BY customer_id
````
| customer_id | total_items | total_amount|
|-------------|-------------|-------------|
| A           | 2           | 25          |
| B           | 3           | 40          |

9.If each $1 spent equates to 10 points and sushi has a 2x points multiplier - how many points would each customer have?
````sql
with pre_data as (
SELECT
  	sa.customer_id,
 	 product_name,
	sum(price) total_amount
FROM 
	 dannys_diner.sales sa
LEFT JOIN 
	 dannys_diner.members mem
ON 
	 sa.customer_id = mem.customer_id
JOIN 
	 dannys_diner.menu me 
ON 
 	 sa.product_id = me.product_id
GROUP BY sa.customer_id,me.product_name
 )

SELECT   
      customer_id,
	  sum (case when product_name = 'sushi' then total_amount *20
      else
     total_amount *10 END) points
FROM
	  pre_data
GROUP BY customer_id    
ORDER BY customer_id

````
| customer_id | total_points |
|-------------|--------------|
| A           | 860          |
| B           | 940          |
| C           | 360          |

10.In the first week after a customer joins the program (including their join date) they earn 2x points on all items, not just sushi - how many points do customer A and B have at the end of January?
````sql
WITH programDates AS (
  SELECT 
    customer_id, 
    join_date,
    DATEADD(d, 6, join_date) AS valid_date, 
    EOMONTH('2021-01-01') AS last_date
  FROM members
)

SELECT 
  p.customer_id,
  SUM(CASE 
      	WHEN s.order_date BETWEEN p.join_date AND p.valid_date THEN m.price*20
      	WHEN m.product_name = 'sushi' THEN m.price*20
      ELSE m.price*10 END) AS total_points
FROM sales s
JOIN programDates p 
  ON s.customer_id = p.customer_id
JOIN menu m 
  ON s.product_id = m.product_id
WHERE s.order_date <= last_date
GROUP BY p.customer_id;
````
| customer_id | total_points |
|-------------|--------------|
| A           | 1370         |
| B           | 820          |          

### Join All The Things 

````sql
SELECT
  	sa.customer_id,
  
  	order_date,
    product_name,
    price,
    CASE WHEN sa.customer_id=mem.customer_id and  order_date > join_date THEN 'Y'
    ELSE 'N' END as member
FROM 
	 dannys_diner.sales sa
LEFT JOIN 
	 dannys_diner.members mem
ON 
	 sa.customer_id = mem.customer_id
JOIN 
	 dannys_diner.menu me 
ON 
 	 sa.product_id = me.product_id

````
| customer_id | order_date | product_name | price | member |
|-------------|------------|--------------|-------|--------|
| A           | 2021-01-01 | sushi        | 10    | N      |
| A           | 2021-01-01 | curry        | 15    | N      |
| A           | 2021-01-07 | curry        | 15    | Y      |
| A           | 2021-01-10 | ramen        | 12    | Y      |
| A           | 2021-01-11 | ramen        | 12    | Y      |
| A           | 2021-01-11 | ramen        | 12    | Y      |
| B           | 2021-01-01 | curry        | 15    | N      |
| B           | 2021-01-02 | curry        | 15    | N      |
| B           | 2021-01-04 | sushi        | 10    | N      |
| B           | 2021-01-11 | sushi        | 10    | Y      |
| B           | 2021-01-16 | ramen        | 12    | Y      |
| B           | 2021-02-01 | ramen        | 12    | Y      |
| C           | 2021-01-01 | ramen        | 12    | N      |
| C           | 2021-01-01 | ramen        | 12    | N      |
| C           | 2021-01-07 | ramen        | 12    | N      |


### Rank All The Things


````sql
WITH pre_data AS (
  SELECT
    sa.customer_id,
    order_date,
    product_name,
    price,
    CASE WHEN sa.customer_id = mem.customer_id AND order_date > join_date THEN 'Y'
         ELSE 'N' END AS member
  FROM 
    dannys_diner.sales sa
  LEFT JOIN 
    dannys_diner.members mem ON sa.customer_id = mem.customer_id
  JOIN 
    dannys_diner.menu me ON sa.product_id = me.product_id
)
SELECT *,
  CASE WHEN member = 'Y' 
    THEN DENSE_RANK() OVER(PARTITION BY customer_id, member ORDER BY order_date)
    ELSE null END AS ranking
FROM pre_data;

````
| customer_id | order_date | product_name | price | member | ranking |
|-------------|------------|--------------|-------|--------|---------|
| A           | 2021-01-01 | sushi        | 10    | N      | NULL    |
| A           | 2021-01-01 | curry        | 15    | N      | NULL    |
| A           | 2021-01-07 | curry        | 15    | Y      | 1       |
| A           | 2021-01-10 | ramen        | 12    | Y      | 2       |
| A           | 2021-01-11 | ramen        | 12    | Y      | 3       |
| A           | 2021-01-11 | ramen        | 12    | Y      | 3       |
| B           | 2021-01-01 | curry        | 15    | N      | NULL    |
| B           | 2021-01-02 | curry        | 15    | N      | NULL    |
| B           | 2021-01-04 | sushi        | 10    | N      | NULL    |
| B           | 2021-01-11 | sushi        | 10    | Y      | 1       |
| B           | 2021-01-16 | ramen        | 12    | Y      | 2       |
| B           | 2021-02-01 | ramen        | 12    | Y      | 3       |
| C           | 2021-01-01 | ramen        | 12    | N      | NULL    |
| C           | 2021-01-01 | ramen        | 12    | N      | NULL    |
| C           | 2021-01-07 | ramen        | 12    | N      | NULL    |

